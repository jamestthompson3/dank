<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-us" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, minimum-scale=1.0,viewport-fit=cover">
    <meta name="robots" content="index, follow">

    <meta name="author" content="Taylor Thompson" />
    <meta name="description" content="Find your friends on the same subnet!" />
    <meta property="og:title" content="Peer Discovery over UDP" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://teukka.tech/peer-discovery.html" />
    <link rel="cannonical" href="https://teukka.tech/peer-discovery.html" />
    <meta property="og:image" content="https://images.unsplash.com/photo-1586307679625-79bf5a822584?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=700&q=80" />
    <link rel="stylesheet" href="./pandocoverride.css" />
    <link rel="stylesheet" href="./atomic.css" />
    <link href="tooltip.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css?family=B612+Mono&display=swap"
      rel="stylesheet"
      />
    <title>ðŸ‘“ Peer Discovery over UDP</title>
<script>
	// Only load on production environment.
	if (window.location.host !== 'teukka.tech')
		window.goatcounter = {no_onload: true};
</script>
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <h3 id="what-is-peer-discovery">What is Peer discovery</h3>
    <p>Peer discovery allows you to discover other computers on the same subnet, intranet, or through the internet. Discovering peers directly removes the necessity of a centralized server architecture, reducing the number of network jumps your packets require to share information with each other. Peer discovery can be used in: discovering microservices in the same docker network or kubernetes cluster, file sharing (like airdrop and bittorrent), and peer to peer gaming. Eliminating a centralized communication server can reduce operating costs, improve communication times between clients, and lead to more robust services since there is no single point of failure. Taking advantage of the benefits listed above requires a decentralized architecture.</p>
    <h3 id="multicast-groups">Multicast Groups</h3>
    <p>Multicasting is one of the tools we can use in creating a decentralized system. Multicasting is the process where messages are sent to a group of participants on the network. Multicasting differs from Broadcasting by only sending data to a specified <em>group</em> of network nodes, whereas broadcasting sends data to all network nodes. Implementing multicasting incurs a distinct set of challenges compared to centralized architectures; consider the following listed by Microsoft's article about <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759719(v=ws.10)">IPV4 Multicasting</a>:</p>
    <ul>
      <li>Multicast traffic is sent to an ambiguous group destination.</li>
      <li>Because group addresses represent different groups with different members, group addresses generally cannot be summarized in the IP multicast forwarding table.</li>
      <li>The location of group members is not consistent, so the IP multicast forwarding table might need to be updated whenever a group member joins or leaves a multicast group. Multicast routing protocols update the IP multicast forwarding table.</li>
    </ul>
    <p>Because the challenges like those listed above, reasoning about multicast traffic requires different mental model than a traditional client-server architecture. A critical concept in multicasting the <em>multicast group</em>. A multicast group can be compared to a chat application: membership is dynamic; members can leave and join at will, group members can be located anywhere on a multicast enabled network (compared to a server with a static IP address), a host can be a member of as many multicast groups as desired. A multicast group <em>can</em> have a well known address, for example 224.0.0.1 is the multicast address for all hosts in the subnet.</p>
    <p>Members of multicast groups listening for incoming traffic will first bind their UDP socket to an available interface and join the multicast group. After joining the group, this member can receive datagram packets on the bound interface without the other members of the group knowing it's specific IP address. A similar process goes for multicast group members sending data to the group. Senders will bind their UDP socket on an available interface and begin transmitting datagram packets to the multicast group address. Through the magic of multicasting, the sender does not require information other than the group address for their packets to reach group members who are listening for incoming data.</p>
    <h3 id="diving-into-the-code">Diving into the code</h3>
    <p>To start multicasting over UDP requires only a few lines of code. For this post, we'll create a small program which sends a username to members of a multicast group. First, we want to set up a listener for other peers sending data to the multicast group. To do this, we need to bind the UDP socket to an available interface and join the multicast group:</p>
    <div>
      <div class="flex-row space-between"  role="tablist" aria-label="Language Select">
        <button aria-controls="cb1" id="rust1" class="p1 tab selected" role="tab" aria-selected="true">Rust</button>
        <button aria-controls="cb2" id="js1" class="p1 tab" role="tab" aria-selected="false">Javascript</button>
      </div>
      <div role="tabpanel" id="cb1" aria-labelledby="rust1">
        <div class="sourceCode"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">std::net::</span><span class="op">{</span>Ipv4Addr<span class="op">,</span> SocketAddrV4<span class="op">,</span> UdpSocket<span class="op">};</span></span>
  <span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a></span>
  <span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">static</span> MULTI_CAST_ADDR<span class="op">:</span> Ipv4Addr <span class="op">=</span> <span class="pp">Ipv4Addr::</span>new(<span class="dv">224</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
  <span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
  <span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">fn</span> listen() <span class="op">{</span></span>
  <span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>  <span class="kw">let</span> socket_address<span class="op">:</span> SocketAddrV4 <span class="op">=</span> <span class="pp">SocketAddrV4::</span>new(<span class="pp">Ipv4Addr::</span>new(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> <span class="dv">9778</span>)<span class="op">;</span></span>
  <span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>  <span class="kw">let</span> bind_addr <span class="op">=</span> <span class="pp">Ipv4Addr::</span>new(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
  <span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>  <span class="kw">let</span> socket <span class="op">=</span> <span class="pp">UdpSocket::</span>bind(socket_address)<span class="op">?;</span></span>
  <span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>  <span class="pp">println!</span>(<span class="st">&quot;Listening on: {}&quot;</span><span class="op">,</span> socket<span class="op">.</span>local_addr()<span class="op">.</span>unwrap())<span class="op">;</span></span>
  <span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>  socket<span class="op">.</span>join_multicast_v4(<span class="op">&amp;</span>MULTI_CAST_ADDR<span class="op">,</span> <span class="op">&amp;</span>bind_addr)<span class="op">?;</span></span>
  <span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="op">}</span></span></code></pre></div>
          <blockquote>
            <p>Notice we create a new IP address struct with the values, <code>0, 0, 0, 0</code>, which the equivalent of saying "Any available IP interface".</p>
          </blockquote>
      </div>
      <div role="tabpanel" id="cb2" aria-labelledby="js1" hidden="true">
        <div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="im">import</span> dgram <span class="im">from</span> <span class="st">&quot;dgram&quot;</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="kw">const</span> MULTI_CAST_ADDR <span class="op">=</span> <span class="st">&quot;224.0.0.1&quot;</span><span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">listen</span>() {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>  <span class="kw">const</span> server <span class="op">=</span> dgram<span class="op">.</span><span class="fu">createSocket</span>(<span class="st">&quot;udp4&quot;</span>)<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>  server<span class="op">.</span><span class="fu">bind</span>(<span class="dv">9778</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>    server<span class="op">.</span><span class="fu">addMembership</span>(MULTI_CAST_ADDR)<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>  })<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>  server<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;listening&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    <span class="kw">const</span> address <span class="op">=</span> server<span class="op">.</span><span class="fu">address</span>()<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Listening on: </span><span class="sc">${</span>address<span class="op">.</span><span class="at">address</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>address<span class="op">.</span><span class="at">port</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>  })<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>}</span></code></pre></div>
      </div>
    </div>
    <p><code>MULTI_CAST_ADDR</code> points an IP address, <code>224.0.0.1</code>, as stated earlier, this is the reserved multicast address for all systems on the current subnet. Since the code is listening for messages being sent to the multicast group, we need to <em>join</em> the group <em>in addition to</em> binding the socket on an available IP Interface. In contrast to a server listening to incoming HTTP connections, we not only bind our server to a local IP address and a port, but we also join a multicast group whose address is part of the subnet. Since we are binding the UDP server to a local address and port <em>and</em> joining the multicast group, it can receive data from a direct connection ( like HTTP ), <em>and</em> from the multicast group.</p>
    <p>Now time for the logic for receiving the multicast group data. Luckily, whether the data coming from the multicast group or from a direct connection, the code the same.</p>
    <div>
      <div class="flex-row space-between"  role="tablist" aria-label="Language Select">
        <button aria-controls="cb3" id="rust2" class="p1 tab selected" role="tab" aria-selected="true">Rust</button>
        <button aria-controls="cb4" id="js2" class="p1 tab" role="tab" aria-selected="false">Javascript</button>
      </div>

      <div role="tabpanel" id="cb3" aria-labelledby="rust2">
        <div class="sourceCode"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">fn</span> listen() <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
  <span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>    <span class="kw">let</span> socket_address<span class="op">:</span> SocketAddrV4 <span class="op">=</span> <span class="pp">SocketAddrV4::</span>new(<span class="pp">Ipv4Addr::</span>new(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> <span class="dv">9778</span>)<span class="op">;</span></span>
  <span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>    <span class="kw">let</span> bind_addr <span class="op">=</span> <span class="pp">Ipv4Addr::</span>new(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
  <span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>    <span class="kw">let</span> socket <span class="op">=</span> <span class="pp">UdpSocket::</span>bind(socket_address)<span class="op">?;</span></span>
  <span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>    <span class="pp">println!</span>(<span class="st">&quot;Listening on: {}&quot;</span><span class="op">,</span> socket<span class="op">.</span>local_addr()<span class="op">.</span>unwrap())<span class="op">;</span></span>
  <span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    socket<span class="op">.</span>join_multicast_v4(<span class="op">&amp;</span>MULTI_CAST_ADDR<span class="op">,</span> <span class="op">&amp;</span>bind_addr)<span class="op">?;</span></span>
  <span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>    <span class="kw">loop</span> <span class="op">{</span></span>
  <span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>        <span class="co">// set up message buffer with size of 120 bytes</span></span>
  <span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>        <span class="kw">let</span> <span class="kw">mut</span> buf <span class="op">=</span> [<span class="dv">0</span><span class="op">;</span> <span class="dv">120</span>]<span class="op">;</span></span>
  <span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>        <span class="kw">let</span> (data<span class="op">,</span> origin) <span class="op">=</span> socket<span class="op">.</span>recv_from(<span class="op">&amp;</span><span class="kw">mut</span> buf)<span class="op">?;</span></span>
  <span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>        <span class="kw">let</span> buf <span class="op">=</span> <span class="op">&amp;</span><span class="kw">mut</span> buf[<span class="op">..</span>data]<span class="op">;</span></span>
  <span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>        <span class="kw">let</span> message <span class="op">=</span> <span class="dt">String</span><span class="pp">::</span>from_utf8(buf<span class="op">.</span>to_vec())<span class="op">.</span>unwrap()<span class="op">;</span></span>
  <span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>        <span class="pp">println!</span>(<span class="st">&quot;server got: {} from {}&quot;</span><span class="op">,</span> message<span class="op">,</span> origin)<span class="op">;</span></span>
  <span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>    <span class="op">}</span></span>
  <span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a><span class="op">}</span></span></code></pre></div>
      </div>

      <div role="tabpanel" id="cb4" aria-labelledby="js2" hidden="true">
        <div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">listen</span>() {</span>
  <span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>  <span class="kw">const</span> server <span class="op">=</span> dgram<span class="op">.</span><span class="fu">createSocket</span>(<span class="st">&quot;udp4&quot;</span>)<span class="op">;</span></span>
  <span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>  <span class="co">// Listen for incoming messages</span></span>
  <span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>  server<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;message&quot;</span><span class="op">,</span> (msg<span class="op">,</span> rinfo) <span class="kw">=&gt;</span> {</span>
  <span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`server got: </span><span class="sc">${</span>msg<span class="sc">}</span><span class="vs"> from </span><span class="sc">${</span>rinfo<span class="op">.</span><span class="at">address</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>rinfo<span class="op">.</span><span class="at">port</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
  <span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>  })<span class="op">;</span></span>
  <span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>  server<span class="op">.</span><span class="fu">bind</span>(<span class="dv">9778</span><span class="op">,</span> (a) <span class="kw">=&gt;</span> {</span>
  <span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>    server<span class="op">.</span><span class="fu">addMembership</span>(MULTI_CAST_ADDR)<span class="op">;</span></span>
  <span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>  })<span class="op">;</span></span>
  <span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>  server<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;listening&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
  <span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    <span class="kw">const</span> address <span class="op">=</span> server<span class="op">.</span><span class="fu">address</span>()<span class="op">;</span></span>
  <span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Listening on: </span><span class="sc">${</span>address<span class="op">.</span><span class="at">address</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>address<span class="op">.</span><span class="at">port</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
  <span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>  })<span class="op">;</span></span>
  <span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>}</span></code></pre></div>
      </div>
    </div>
    <p>After setting up logic for listening to incoming messages on the multicast group address, our basic server is done! Now we can create the function that will send packets to the multicast address:</p>
    <div>

      <div class="flex-row space-between"  role="tablist" aria-label="Language Select">
        <button aria-controls="cb5" id="rust3" class="p1 tab selected" role="tab" aria-selected="true">Rust</button>
        <button aria-controls="cb6" id="js3" class="p1 tab" role="tab" aria-selected="false">Javascript</button>
      </div>

      <div role="tabpanel" id="cb5" aria-labelledby="rust3">
        <div class="sourceCode"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">std::net::</span><span class="op">{</span>Ipv4Addr<span class="op">,</span> SocketAddrV4<span class="op">,</span> UdpSocket<span class="op">};</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="kw">static</span> MULTI_CAST_ADDR<span class="op">:</span> Ipv4Addr <span class="op">=</span> <span class="pp">Ipv4Addr::</span>new(<span class="dv">224</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">fn</span> cast() <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>    <span class="kw">let</span> socket_address<span class="op">:</span> SocketAddrV4 <span class="op">=</span> <span class="pp">SocketAddrV4::</span>new(<span class="pp">Ipv4Addr::</span>new(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>    <span class="kw">let</span> socket <span class="op">=</span> <span class="pp">UdpSocket::</span>bind(socket_address)<span class="op">?;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>    socket<span class="op">.</span>connect(<span class="pp">SocketAddrV4::</span>new(MULTI_CAST_ADDR<span class="op">,</span> <span class="dv">9778</span>))<span class="op">?;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>    <span class="co">// Don&#39;t send messages to yourself.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>    <span class="co">// In this case self discovery is for human developers, not machines.</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>    socket<span class="op">.</span>set_multicast_loop_v4(<span class="cn">false</span>)<span class="op">?;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>    <span class="kw">let</span> data <span class="op">=</span> <span class="dt">String</span><span class="pp">::</span>from(<span class="st">&quot;{</span><span class="sc">\&quot;</span><span class="st">username</span><span class="sc">\&quot;</span><span class="st">: </span><span class="sc">\&quot;</span><span class="st">test</span><span class="sc">\&quot;</span><span class="st">}&quot;</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>     <span class="kw">loop</span> <span class="op">{</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>        socket<span class="op">.</span>send(data<span class="op">.</span>as_bytes())<span class="op">?;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a>        <span class="pp">thread::</span>sleep(<span class="pp">time::Duration::</span>from_secs(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>    <span class="cn">Ok</span>(())</span></code></pre></div>
      </div>

      <div role="tabpanel" id="cb6" aria-labelledby="js4" hidden="true">
        <div class="sourceCode" ><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="im">import</span> dgram <span class="im">from</span> <span class="st">&quot;dgram&quot;</span><span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="kw">const</span> MULTI_CAST_ADDR <span class="op">=</span> <span class="st">&quot;224.0.0.1&quot;</span><span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">cast</span>() {</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>  <span class="kw">const</span> client <span class="op">=</span> dgram<span class="op">.</span><span class="fu">createSocket</span>(<span class="st">&quot;udp4&quot;</span>)<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>  <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    <span class="kw">const</span> message <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">from</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">username</span><span class="op">:</span> <span class="st">&quot;hackerman1337&quot;</span> }))<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    client<span class="op">.</span><span class="fu">send</span>(message<span class="op">,</span> <span class="dv">9778</span><span class="op">,</span> MULTI_CAST_ADDR)<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>  }<span class="op">,</span> <span class="dv">2000</span>)<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>}</span></code></pre></div>
      </div>
    </div>
    <p>Unlike the <code>listen</code> function, when we are sending data to the multicast address, we don't need to join the multicast group. Since we are using UDP for peer discovery, we can fire and forget these messages from the <code>cast</code> function as there will be no response from the server.</p>
    <p>To test our peer discovery functions, you need two computers connected to the same subnet, or two docker containers running in the same docker network, or a docker container and your computer. Note that while you don't need to expose docker ports in order for the program running on your computer to discover the program running in the docker container, you will need to expose ports in order for your container to discover the host machine. We also need to combine our two functions so that we are both broadcasting our presence and listening for peers.</p>

    <div>
      <div class="flex-row space-between"  role="tablist" aria-label="Language Select">
        <button aria-controls="cb7" id="rust4" class="p1 tab selected" role="tab" aria-selected="true">Rust</button>
        <button aria-controls="cb8" id="js4" class="p1 tab" role="tab" aria-selected="false">Javascript</button>
      </div>

      <div role="tabpanel" id="cb7" aria-labelledby="rust4">
        <div class="sourceCode"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">std::</span>thread<span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>    <span class="pp">thread::</span>spawn(<span class="op">||{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>        listen()<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>    cast()<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a><span class="op">}</span></span></code></pre></div>
      </div>

      <div role="tabpanel" id="cb8" aria-labelledby="js4" hidden="true">
        <div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="im">import</span> cluster <span class="im">from</span> <span class="st">&quot;cluster&quot;</span><span class="op">;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">main</span>() {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>  <span class="cf">if</span> (cluster<span class="op">.</span><span class="at">isMaster</span>) {</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>    cluster<span class="op">.</span><span class="fu">fork</span>()<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    listen()<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cluster<span class="op">.</span><span class="at">isWorker</span>) {</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>    cast()<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>  }</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>}</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>main()<span class="op">;</span></span></code></pre></div>
      </div>
    </div>
    <p>That's it! If you run the program on two different computers on the same subnet, or two docker containers in the same docker network, you can observe the peers are able to discover each other's username and IP Address. The final code output:</p>
    <div>

      <div class="flex-row space-between"  role="tablist" aria-label="Language Select">
        <button aria-controls="cb9" id="rust5" class="p1 tab selected" role="tab" aria-selected="true">Rust</button>
        <button aria-controls="cb10" id="js5" class="p1 tab" role="tab" aria-selected="false">Javascript</button>
      </div>
      <div role="tabpanel" id="cb9" aria-labelledby="rust5">
        <div class="sourceCode" ><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">std::net::</span><span class="op">{</span>Ipv4Addr<span class="op">,</span> SocketAddrV4<span class="op">,</span> UdpSocket<span class="op">};</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">std::</span>thread<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a><span class="kw">static</span> MULTI_CAST_ADDR<span class="op">:</span> Ipv4Addr <span class="op">=</span> <span class="pp">Ipv4Addr::</span>new(<span class="dv">224</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">fn</span> listen() <span class="op">{</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>  <span class="kw">let</span> socket_address<span class="op">:</span> SocketAddrV4 <span class="op">=</span> <span class="pp">SocketAddrV4::</span>new(<span class="pp">Ipv4Addr::</span>new(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> <span class="dv">9778</span>)<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>  <span class="kw">let</span> bind_addr <span class="op">=</span> <span class="pp">Ipv4Addr::</span>new(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>  <span class="kw">let</span> socket <span class="op">=</span> <span class="pp">UdpSocket::</span>bind(socket_address)<span class="op">?;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>  <span class="pp">println!</span>(<span class="st">&quot;Listening on: {}&quot;</span><span class="op">,</span> socket<span class="op">.</span>local_addr()<span class="op">.</span>unwrap())<span class="op">;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>  socket<span class="op">.</span>join_multicast_v4(<span class="op">&amp;</span>MULTI_CAST_ADDR<span class="op">,</span> <span class="op">&amp;</span>bind_addr)<span class="op">?;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">fn</span> cast() <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a>  <span class="kw">let</span> socket_address<span class="op">:</span> SocketAddrV4 <span class="op">=</span> <span class="pp">SocketAddrV4::</span>new(<span class="pp">Ipv4Addr::</span>new(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a>  <span class="kw">let</span> socket <span class="op">=</span> <span class="pp">UdpSocket::</span>bind(socket_address)<span class="op">?;</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a>  socket<span class="op">.</span>connect(<span class="pp">SocketAddrV4::</span>new(MULTI_CAST_ADDR<span class="op">,</span> <span class="dv">9778</span>))<span class="op">?;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>  <span class="co">// Don&#39;t send messages to yourself.</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a>  <span class="co">// In this case self discovery is for human developers, not machines.</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a>  socket<span class="op">.</span>set_multicast_loop_v4(<span class="cn">false</span>)<span class="op">?;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a>  <span class="kw">let</span> data <span class="op">=</span> <span class="dt">String</span><span class="pp">::</span>from(<span class="st">&quot;{</span><span class="sc">\&quot;</span><span class="st">username</span><span class="sc">\&quot;</span><span class="st">: </span><span class="sc">\&quot;</span><span class="st">test</span><span class="sc">\&quot;</span><span class="st">}&quot;</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>   <span class="kw">loop</span> <span class="op">{</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a>    socket<span class="op">.</span>send(data<span class="op">.</span>as_bytes())<span class="op">?;</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a>    <span class="pp">thread::</span>sleep(<span class="pp">time::Duration::</span>from_secs(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a>  <span class="op">}</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>  <span class="cn">Ok</span>(())</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true"></a>    <span class="pp">thread::</span>spawn(<span class="op">||{</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true"></a>        listen()<span class="op">;</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true"></a>    cast()<span class="op">;</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true"></a><span class="op">}</span></span></code></pre></div>
      </div>

      <div role="tabpanel" id="cb10" aria-labelledby="js5" hidden="true">
        <div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="im">import</span> dgram <span class="im">from</span> <span class="st">&quot;dgram&quot;</span><span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="im">import</span> cluster <span class="im">from</span> <span class="st">&quot;cluster&quot;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="kw">const</span> MULTI_CAST_ADDR <span class="op">=</span> <span class="st">&quot;224.0.0.1&quot;</span><span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">listen</span>() {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>  <span class="kw">const</span> server <span class="op">=</span> dgram<span class="op">.</span><span class="fu">createSocket</span>(<span class="st">&quot;udp4&quot;</span>)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>  server<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;message&quot;</span><span class="op">,</span> (msg<span class="op">,</span> rinfo) <span class="kw">=&gt;</span> {</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`server got: </span><span class="sc">${</span>msg<span class="sc">}</span><span class="vs"> from </span><span class="sc">${</span>rinfo<span class="op">.</span><span class="at">address</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>rinfo<span class="op">.</span><span class="at">port</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a>  })<span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>  server<span class="op">.</span><span class="fu">bind</span>(<span class="dv">9778</span><span class="op">,</span> (a) <span class="kw">=&gt;</span> {</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a>    server<span class="op">.</span><span class="fu">addMembership</span>(MULTI_CAST_ADDR)<span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a>  })<span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>  server<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;listening&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a>    <span class="kw">const</span> address <span class="op">=</span> server<span class="op">.</span><span class="fu">address</span>()<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Listening on: </span><span class="sc">${</span>address<span class="op">.</span><span class="at">address</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>address<span class="op">.</span><span class="at">port</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a>  })<span class="op">;</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a>}</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">cast</span>() {</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true"></a>  <span class="kw">const</span> client <span class="op">=</span> dgram<span class="op">.</span><span class="fu">createSocket</span>(<span class="st">&quot;udp4&quot;</span>)<span class="op">;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true"></a>  <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true"></a>    <span class="kw">const</span> message <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">from</span>(<span class="st">&quot;TEST&quot;</span>)<span class="op">;</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true"></a>    client<span class="op">.</span><span class="fu">send</span>(message<span class="op">,</span> <span class="dv">9778</span><span class="op">,</span> MULTI_CAST_ADDR)<span class="op">;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true"></a>  }<span class="op">,</span> <span class="dv">2000</span>)<span class="op">;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true"></a>}</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">main</span>() {</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true"></a>  <span class="cf">if</span> (cluster<span class="op">.</span><span class="at">isMaster</span>) {</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true"></a>    cluster<span class="op">.</span><span class="fu">fork</span>()<span class="op">;</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true"></a>    listen()<span class="op">;</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cluster<span class="op">.</span><span class="at">isWorker</span>) {</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true"></a>    cast()<span class="op">;</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true"></a>  }</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true"></a>}</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true"></a>main()<span class="op">;</span></span></code></pre></div>
      </div>
    </div>
    <script src="peer-discovery.js"></script>
  <script src="./blogheader.js"></script>
  <script data-goatcounter="https://teukka_tech.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
  </body>
</html>
