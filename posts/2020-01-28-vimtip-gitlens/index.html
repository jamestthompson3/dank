<!doctype html><html><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>ðŸ’¡ 5 Minute Neovim Tip - GitLens</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=canonical href=https://teukka.tech/posts/2020-01-28-vimtip-gitlens/>
<link rel=webmention href=https://webmention.io/teukka.tech/webmention>
<link rel=pingback href=https://webmention.io/teukka.tech/xmlrpc>
<link rel=micropub href=http://pub.teukka.tech/micropub/main><meta property="og:title" content="Neovim Tip, GitLens">
<meta property="og:description" content="Replicate the basic functionality VSCode's GitLens in 26 lines of lua">
<meta property="og:type" content="article">
<meta property="og:url" content="https://teukka.tech/posts/2020-01-28-vimtip-gitlens/"><meta property="og:image" content="https://neovim.io/images/logo@2x.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-01-28T00:00:00+00:00">
<meta property="article:modified_time" content="2020-01-28T00:00:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://neovim.io/images/logo@2x.png">
<meta name=twitter:title content="Neovim Tip, GitLens">
<meta name=twitter:description content="Replicate the basic functionality VSCode's GitLens in 26 lines of lua">
<link href=https://teukka.tech/css/fonts.css rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://teukka.tech/css/main.css>
<link rel=stylesheet type=text/css media=screen href=https://teukka.tech/css/paginator.css>
<link rel=stylesheet type=text/css media=screen href=https://teukka.tech/css/hcard.css>
<link rel=stylesheet type=text/css media=screen href=https://teukka.tech/css/updates.css>
<link rel=stylesheet type=text/css media=screen href=https://teukka.tech/css/fastsearch.css>
<link rel=stylesheet type=text/css media=screen href=https://teukka.tech/css/bookmarks.css><link rel=stylesheet type=text/css href=https://teukka.tech/css/dark.css media="(prefers-color-scheme: dark)">
<script>window.location.host!=='teukka.tech'&&(window.goatcounter={no_onload:!0})</script>
</head>
<body>
<div class=content><header>
<div class=main>
<a class=homepage href=https://teukka.tech/>teukka.tech</a>
</div>
<nav>
<a href=/posts>posts</a>
<a href=/updates>updates</a>
<a href=/photos>photos</a>
<a href=/bookmarks>bookmarks</a>
<a href=/knowledgebase>knowledge base</a>
</nav>
<div id=fastSearch>
<label for=searchInput style=display:none>search the blog</label>
<input id=searchInput tabindex=0 placeholder="search ðŸ”">
<ul id=searchResults>
</ul>
</div>
</header>
<main>
<br>
<br>
<article class="h-entry post">
<div class=title>
<h1 class=title><a class="p-name u-url" href=https://teukka.tech/posts/2020-01-28-vimtip-gitlens/>Neovim Tip, GitLens</a></h1>
<div class="dt-published meta">Posted on 2020-01-28</div>
<a rel=author class="p-author h-card" href=/>taylor thompson</a>
</div>
<div class=post-tags>
<nav class="nav tags">
<ul class=tags>
<li><a class=p-category href=/tags/neovim>neovim</a></li>
<li><a class=p-category href=/tags/lua>lua</a></li>
<li><a class=p-category href=/tags/productivity>productivity</a></li>
</ul>
</nav>
</div>
<section class="body e-content">
<h2 id=intro>Intro</h2>
<p><a href="https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens">GitLens</a> is a VSCode plugin that, among other things, allows you to see the time, commit author, and commit message of the current line. With a little help from to the neovim api and our shell, it we can recreate this functionality in a few lines of lua code.</p>
<h2 id=the-code>The Code</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#0f0>-- in utils.lua</span>
<span style=color:red>local</span> M = {}
<span style=color:red>local</span> api = vim.api
<span style=color:red>function</span> M.<span style=color:#ff0>blameVirtText</span>()
  <span style=color:red>local</span> ft = vim.fn.expand(<span style=color:#87ceeb>&#39;%:h:t&#39;</span>) <span style=color:#0f0>-- get the current file extension</span>
  <span style=color:red>if</span> ft == <span style=color:#87ceeb>&#39;&#39;</span> <span style=color:red>then</span> <span style=color:#0f0>-- if we are in a scratch buffer or unknown filetype</span>
    <span style=color:red>return</span>
  <span style=color:red>end</span>
  <span style=color:red>if</span> ft == <span style=color:#87ceeb>&#39;bin&#39;</span> <span style=color:red>then</span> <span style=color:#0f0>-- if we are in nvim&#39;s terminal window</span>
    <span style=color:red>return</span>
  <span style=color:red>end</span>
  api.nvim_buf_clear_namespace(<span style=color:#f60>0</span>, <span style=color:#f60>2</span>, <span style=color:#f60>0</span>, -<span style=color:#f60>1</span>) <span style=color:#0f0>-- clear out virtual text from namespace 2 (the namespace we will set later)</span>
  <span style=color:red>local</span> currFile = vim.fn.expand(<span style=color:#87ceeb>&#39;%&#39;</span>)
  <span style=color:red>local</span> line = api.nvim_win_get_cursor(<span style=color:#f60>0</span>)
  <span style=color:red>local</span> blame = vim.fn.system(string.format(<span style=color:#87ceeb>&#39;git blame -c -L %d,%d %s&#39;</span>, line[<span style=color:#f60>1</span>], line[<span style=color:#f60>1</span>], currFile))
  <span style=color:red>local</span> hash = vim.split(blame, <span style=color:#87ceeb>&#39;%s&#39;</span>)[<span style=color:#f60>1</span>]
  <span style=color:red>local</span> cmd = string.format(<span style=color:#87ceeb>&#34;git show %s &#34;</span>, hash)..<span style=color:#87ceeb>&#34;--format=&#39;%an | %ar | %s&#39;&#34;</span>
  <span style=color:red>if</span> hash == <span style=color:#87ceeb>&#39;00000000&#39;</span> <span style=color:red>then</span>
    text = <span style=color:#87ceeb>&#39;Not Committed Yet&#39;</span>
  <span style=color:red>else</span>
    text = vim.fn.system(cmd)
    text = vim.split(text, <span style=color:#87ceeb>&#39;</span><span style=color:#87ceeb>\n</span><span style=color:#87ceeb>&#39;</span>)[<span style=color:#f60>1</span>]
    <span style=color:red>if</span> text:gmatch(<span style=color:#87ceeb>&#34;fatal&#34;</span>) <span style=color:red>then</span> <span style=color:#0f0>-- if the call to git show fails</span>
      text = <span style=color:#87ceeb>&#39;Not Committed Yet&#39;</span>
    <span style=color:red>end</span>
  <span style=color:red>end</span>
  api.nvim_buf_set_virtual_text(<span style=color:#f60>0</span>, <span style=color:#f60>2</span>, line[<span style=color:#f60>1</span>] - <span style=color:#f60>1</span>, {{ text,<span style=color:#87ceeb>&#39;GitLens&#39;</span> }}, {}) <span style=color:#0f0>-- set virtual text for namespace 2 with the content from git and assign it to the higlight group &#39;GitLens&#39;</span>
<span style=color:red>end</span>

<span style=color:red>function</span> M.<span style=color:#ff0>clearBlameVirtText</span>() <span style=color:#0f0>-- important for clearing out the text when our cursor moves</span>
  api.nvim_buf_clear_namespace(<span style=color:#f60>0</span>, <span style=color:#f60>2</span>, <span style=color:#f60>0</span>, -<span style=color:#f60>1</span>)
<span style=color:red>end</span>

<span style=color:red>return</span> M
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#0f0>&#34; in init.vim</span>
lua vim.api.nvim_command [[autocmd CursorHold   * lua require<span style=color:#87ceeb>&#39;utils&#39;</span>.blameVirtText()]]
lua vim.api.nvim_command [[autocmd CursorMoved  * lua require<span style=color:#87ceeb>&#39;utils&#39;</span>.clearBlameVirtText()]]
lua vim.api.nvim_command [[autocmd CursorMovedI * lua require<span style=color:#87ceeb>&#39;utils&#39;</span>.clearBlameVirtText()]]

hi! link GitLens Comment
</code></pre></div>
</section>
</article>
</main>
<h3>See Also</h3>
<ul>
<li><a href=/posts/2020-01-07-vimloop/>Using LibUV in Neovim</a></li>
<li><a href=/posts/2019-12-19-luanvim/>From init.vim to init.lua</a></li>
<li><a href=/posts/2019-08-25-vimcandothat/>Vim does that already</a></li>
</ul>
<div class=webmention>
<h3>Mentioned around the web</h3>
<div class=webmention-container>
<div class="webmention-profile -ellipsis">
<img src=https://webmention.io/avatar/www.redditstatic.com/788bff4068aa152c91ffc343578adf36810208ab4ea6aa31c09c5a4666ee0955.png alt="author's profile picture">
<span><a href=https://reddit.com/user/brain_emesis/>brain_emesis</a></span>
</div>
<div class=webmention-content>
<i class=comment-date>commented on Feb 15, 2020 <a href=https://reddit.com/r/neovim/comments/f1vxhl/replicate_the_basic_functionality_vscodes_gitlens/fhosztw/>see original</a></i>
<div><p>This is really cool, thanks for sharing</p></div>
</div>
</div>
<div class=webmention-container>
<div class="webmention-profile -ellipsis">
<img src=https://webmention.io/avatar/www.redditstatic.com/5f9b17afed30814d2187f911dd80f3d41da14cb61000674863e170693a99512b.png alt="author's profile picture">
<span><a href=https://reddit.com/user/pain666/>pain666</a></span>
</div>
<div class=webmention-content>
<i class=comment-date>commented on Feb 11, 2020 <a href=https://reddit.com/r/neovim/comments/f1vxhl/replicate_the_basic_functionality_vscodes_gitlens/fhacben/>see original</a></i>
<div><p>Is there an installable form for this?</p></div>
</div>
</div>
<div class=webmention-container>
<div class="webmention-profile -ellipsis">
<img src=https://webmention.io/avatar/www.redditstatic.com/a4f07db0ec0ba25e6d2154f859e2f1e65da74cddad5dff06ad39b0c7522696aa.png alt="author's profile picture">
<span><a href=https://reddit.com/user/ContentForager/>ContentForager</a></span>
</div>
<div class=webmention-content>
<i class=comment-date>commented on Feb 14, 2020 <a href=https://reddit.com/r/mistyfront/comments/f3yzgw/replicate_the_basic_functionality_vscodes_gitlens/fhmmz1g/>see original</a></i>
<div><p><a href=https://www.reddit.com/r/neovim/comments/f1vxhl/replicate_the_basic_functionality_vscodes_gitlens/>Source</a> at <a href=https://brid.gy/r/neovim>/r/neovim</a></p>
<a class=u-mention href=https://teukka.tech/vimtip-gitlens.html></a></div>
</div>
</div>
<div class=webmention-container>
<div class="webmention-profile -ellipsis">
<img src=https://webmention.io/avatar/www.redditstatic.com/4392876210d4e62ce3e816fdcb389d791a3b8c61a3951f07bc1c7bba618b039c.png alt="author's profile picture">
<span><a href=https://reddit.com/user/pjcj/>pjcj</a></span>
</div>
<div class=webmention-content>
<i class=comment-date>commented on Feb 11, 2020 <a href=https://reddit.com/r/neovim/comments/f1vxhl/replicate_the_basic_functionality_vscodes_gitlens/fhaoel1/>see original</a></i>
<div><p>Nice!</p>
<p>This one's vimscript and somewhat longer but has been working well for me: <a href=https://github.com/APZelos/blamer.nvim>https://github.com/APZelos/blamer.nvim</a></p></div>
</div>
</div>
<div class=webmention-container>
<div class="webmention-profile -ellipsis">
<img src=https://webmention.io/avatar/styles.redditmedia.com/52e3f714d08b929461ec8a4092b68a8d9b0e9c0f76552e0553c87994146f1b38.png alt="author's profile picture">
<span><a href=https://reddit.com/user/the_real_albro/>the_real_albro</a></span>
</div>
<div class=webmention-content>
<i class=comment-date>commented on Aug 9, 2020 <a href=https://reddit.com/r/neovim/comments/i61cic/neovim_lua_articles/g0xjysj/>see original</a></i>
<div><p>These were saved in my pocket... </p>
<p><a href=https://github.com/rafcamlet/nvim-luapad/tree/master/spec>https://github.com/rafcamlet/nvim-luapad/tree/master/spec</a></p>
<p><a href=https://www.2n.pl/blog/how-to-write-neovim-plugins-in-lua>https://www.2n.pl/blog/how-to-write-neovim-plugins-in-lua</a></p>
<p><a href=https://teukka.tech/luanvim.html>https://teukka.tech/luanvim.html</a></p>
<a class=u-mention href=https://gabrielpoca.com/2019-11-02-a-little-bit-of-lua-in-your-vim/></a>
<a class=u-mention href=https://oli.me.uk/neovim-configuration-and-plugins-in-fennel-lisp/></a>
<a class=u-mention href=https://teukka.tech/vimtip-gitlens.html></a>
<a class=u-mention href=https://www.2n.pl/blog/how-to-write-neovim-plugins-in-lua></a></div>
</div>
</div>
<div class=webmention-container>
<div class="webmention-profile -ellipsis">
<img src=https://webmention.io/avatar/www.redditstatic.com/788bff4068aa152c91ffc343578adf36810208ab4ea6aa31c09c5a4666ee0955.png alt="author's profile picture">
<span><a href=https://reddit.com/user/brain_emesis/>brain_emesis</a></span>
</div>
<div class=webmention-content>
<i class=comment-date>commented on Sep 10, 2020 <a href=https://reddit.com/r/neovim/comments/i61cic/neovim_lua_articles/g4maoip/>see original</a></i>
<div><p>Another one: <a href=https://github.com/svermeulen/vimpeccable>svermeulen/vimpeccable</a></p>
<a class=u-mention href=https://gabrielpoca.com/2019-11-02-a-little-bit-of-lua-in-your-vim/></a>
<a class=u-mention href=https://oli.me.uk/neovim-configuration-and-plugins-in-fennel-lisp/></a>
<a class=u-mention href=https://teukka.tech/vimtip-gitlens.html></a>
<a class=u-mention href=https://www.2n.pl/blog/how-to-write-neovim-plugins-in-lua></a></div>
</div>
</div>
<div class=webmention-container>
<div class="webmention-profile -ellipsis">
<img src=https://webmention.io/avatar/www.redditstatic.com/e2ab1db56a12e500f2ae292b9694d0b073754645ebcaf80925bc4f37b276bcfc.png alt="author's profile picture">
<span><a href=https://reddit.com/user/Wolfy87/>Wolfy87</a></span>
</div>
<div class=webmention-content>
<i class=comment-date>commented on Aug 8, 2020 <a href=https://reddit.com/r/neovim/comments/i61cic/neovim_lua_articles/g0tq9gr/>see original</a></i>
<div><p><a href=https://oli.me.uk/neovim-configuration-and-plugins-in-fennel-lisp/>https://oli.me.uk/neovim-configuration-and-plugins-in-fennel-lisp/</a></p>
<p>Throwing my own hat into the ring :D</p>
<p>Fennel is a Lisp which I compile to Lua for all of my configuration and plugins.</p>
<a class=u-mention href=https://gabrielpoca.com/2019-11-02-a-little-bit-of-lua-in-your-vim/></a>
<a class=u-mention href=https://oli.me.uk/neovim-configuration-and-plugins-in-fennel-lisp/></a>
<a class=u-mention href=https://teukka.tech/vimtip-gitlens.html></a>
<a class=u-mention href=https://www.2n.pl/blog/how-to-write-neovim-plugins-in-lua></a></div>
</div>
</div>
<div class=webmention-container>
<div class="webmention-profile -ellipsis">
<img src=https://webmention.io/avatar/www.redditstatic.com/99e7791738d395b261de130accbd4ed98677f6a9a51b1dd666057c74d134be04.png alt="author's profile picture">
<span><a href=https://reddit.com/user/eva_kuator/>eva_kuator</a></span>
</div>
<div class=webmention-content>
<i class=comment-date>commented on Aug 8, 2020 <a href=https://reddit.com/r/neovim/comments/i61cic/neovim_lua_articles/>see original</a></i>
<div>Just a bunch of articles about using lua in neovim config and neovim plugins:
- https://gabrielpoca.com/2019-11-02-a-little-bit-of-lua-in-your-vim/
- https://www.2n.pl/blog/how-to-write-neovim-plugins-in-lua
- https://teukka.tech/vimtip-gitlens.html
- Upd: https://oli.me.uk/neovim-configuration-and-plugins-in-fennel-lisp/
<a href=https://gabrielpoca.com/2019-11-02-a-little-bit-of-lua-in-your-vim/>https://gabrielpoca.com/2019-11-02-a-little-bit-of-lua-in-your-vim/</a>
<a href=https://oli.me.uk/neovim-configuration-and-plugins-in-fennel-lisp/>https://oli.me.uk/neovim-configuration-and-plugins-in-fennel-lisp/</a>
<a href=https://teukka.tech/vimtip-gitlens.html>https://teukka.tech/vimtip-gitlens.html</a>
<a href=https://www.2n.pl/blog/how-to-write-neovim-plugins-in-lua>https://www.2n.pl/blog/how-to-write-neovim-plugins-in-lua</a></div>
<p> Mentioned on <a href=https://reddit.com/r/neovim/comments/i61cic/neovim_lua_articles/>https://reddit.com/r/neovim/comments/i61cic/neovim_lua_articles/</a></p>
</div>
</div>
<div class=webmention-container>
<div class="webmention-profile -ellipsis"><svg class="webmention-fallback" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" fill="currentcolor"><path d="M17 7H7A1 1 0 007 9H17a1 1 0 000-2zm0 4H7a1 1 0 000 2H17a1 1 0 000-2zm2-9H5A3 3 0 002 5V15a3 3 0 003 3H16.59l3.7 3.71A1 1 0 0021 22a.84.84.0 00.38-.08A1 1 0 0022 21V5A3 3 0 0019 2zm1 16.59-2.29-2.3A1 1 0 0017 16H5a1 1 0 01-1-1V5A1 1 0 015 4H19a1 1 0 011 1z"/></svg>
<span><a href></a></span>
</div>
<div class=webmention-content>
<p> Mentioned on <a href=https://reposhub.com/linux/system-utilities/ttys3-nvim-blamer-lua.html>https://reposhub.com/linux/system-utilities/ttys3-nvim-blamer-lua.html</a></p>
</div>
</div>
</div>
<script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><footer>
<hr><div class=h-card>
<a class=pic-link href=https://en.wikipedia.org/wiki/Pygmy_slow_loris><img class=u-photo src=https://teukka.tech/Nycticebus_pygmaeus_002.jpg alt="pygmy
    slow loris, an endangered and beautiful creature"></a>
<div class=info>
<span class=p-name>Taylor Thompson</span>
<a class=u-email href=mailto:taylor@teukka.tech>taylor@teukka.tech</a>
<a rel=me class=u-url>https://teukka.tech</a>
<span class=p-note>eternally curious person</span>
</div>
</div>
</footer>
<script data-goatcounter=https://teukka_tech.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
</div>
</body>
</html>