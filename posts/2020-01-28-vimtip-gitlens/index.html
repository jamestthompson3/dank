<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>üí° 5 Minute Neovim Tip - GitLens</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:image" content><link rel=canonical href=https://teukka.tech/posts/2020-01-28-vimtip-gitlens/><meta property="og:title" content="Neovim Tip, GitLens"><meta property="og:description" content="Replicate the basic functionality VSCode's GitLens in 26 lines of lua"><meta property="og:type" content="article"><meta property="og:url" content="https://teukka.tech/posts/2020-01-28-vimtip-gitlens/"><meta property="og:image" content="https://neovim.io/images/logo@2x.png"><meta property="article:published_time" content="2020-01-28T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-28T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://neovim.io/images/logo@2x.png"><meta name=twitter:title content="Neovim Tip, GitLens"><meta name=twitter:description content="Replicate the basic functionality VSCode's GitLens in 26 lines of lua"><link href=https://teukka.techcss/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://teukka.techcss/main.css><link rel=stylesheet type=text/css href=https://teukka.techcss/dark.css media="(prefers-color-scheme: dark)"><script>if(window.location.host!=='teukka.tech')
window.goatcounter={no_onload:true};</script></head><body><div class=content><header><div class=main><a href=https://teukka.tech>Taylor Thompson's Blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/knowledgebase>Knowledge Base</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Neovim Tip, GitLens</h1><div class=meta>Posted on Jan 28, 2020</div></div><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/neovim>neovim</a></li><li><a href=/tags/lua>lua</a></li><li><a href=/tags/productivity>productivity</a></li></ul></nav></div><section class=body><h2 id=intro>Intro</h2><p><a href="https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens">GitLens</a> is a VSCode plugin that, among other things, allows you to see the time, commit author, and commit message of the current line. With a little help from to the neovim api and our shell, it we can recreate this functionality in a few lines of lua code.</p><h2 id=the-code>The Code</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#0f0>-- in utils.lua</span>
<span style=color:red>local</span> M = {}
<span style=color:red>local</span> api = vim.api
<span style=color:red>function</span> M.<span style=color:#ff0>blameVirtText</span>()
  <span style=color:red>local</span> ft = vim.fn.expand(<span style=color:#87ceeb>&#39;%:h:t&#39;</span>) <span style=color:#0f0>-- get the current file extension</span>
  <span style=color:red>if</span> ft == <span style=color:#87ceeb>&#39;&#39;</span> <span style=color:red>then</span> <span style=color:#0f0>-- if we are in a scratch buffer or unknown filetype</span>
    <span style=color:red>return</span>
  <span style=color:red>end</span>
  <span style=color:red>if</span> ft == <span style=color:#87ceeb>&#39;bin&#39;</span> <span style=color:red>then</span> <span style=color:#0f0>-- if we are in nvim&#39;s terminal window</span>
    <span style=color:red>return</span>
  <span style=color:red>end</span>
  api.nvim_buf_clear_namespace(<span style=color:#f60>0</span>, <span style=color:#f60>2</span>, <span style=color:#f60>0</span>, -<span style=color:#f60>1</span>) <span style=color:#0f0>-- clear out virtual text from namespace 2 (the namespace we will set later)</span>
  <span style=color:red>local</span> currFile = vim.fn.expand(<span style=color:#87ceeb>&#39;%&#39;</span>)
  <span style=color:red>local</span> line = api.nvim_win_get_cursor(<span style=color:#f60>0</span>)
  <span style=color:red>local</span> blame = vim.fn.system(string.format(<span style=color:#87ceeb>&#39;git blame -c -L %d,%d %s&#39;</span>, line[<span style=color:#f60>1</span>], line[<span style=color:#f60>1</span>], currFile))
  <span style=color:red>local</span> hash = vim.split(blame, <span style=color:#87ceeb>&#39;%s&#39;</span>)[<span style=color:#f60>1</span>]
  <span style=color:red>local</span> cmd = string.format(<span style=color:#87ceeb>&#34;git show %s &#34;</span>, hash)..<span style=color:#87ceeb>&#34;--format=&#39;%an | %ar | %s&#39;&#34;</span>
  <span style=color:red>if</span> hash == <span style=color:#87ceeb>&#39;00000000&#39;</span> <span style=color:red>then</span>
    text = <span style=color:#87ceeb>&#39;Not Committed Yet&#39;</span>
  <span style=color:red>else</span>
    text = vim.fn.system(cmd)
    text = vim.split(text, <span style=color:#87ceeb>&#39;</span><span style=color:#87ceeb>\n</span><span style=color:#87ceeb>&#39;</span>)[<span style=color:#f60>1</span>]
    <span style=color:red>if</span> text:gmatch(<span style=color:#87ceeb>&#34;fatal&#34;</span>) <span style=color:red>then</span> <span style=color:#0f0>-- if the call to git show fails</span>
      text = <span style=color:#87ceeb>&#39;Not Committed Yet&#39;</span>
    <span style=color:red>end</span>
  <span style=color:red>end</span>
  api.nvim_buf_set_virtual_text(<span style=color:#f60>0</span>, <span style=color:#f60>2</span>, line[<span style=color:#f60>1</span>] - <span style=color:#f60>1</span>, {{ text,<span style=color:#87ceeb>&#39;GitLens&#39;</span> }}, {}) <span style=color:#0f0>-- set virtual text for namespace 2 with the content from git and assign it to the higlight group &#39;GitLens&#39;</span>
<span style=color:red>end</span>

<span style=color:red>function</span> M.<span style=color:#ff0>clearBlameVirtText</span>() <span style=color:#0f0>-- important for clearing out the text when our cursor moves</span>
  api.nvim_buf_clear_namespace(<span style=color:#f60>0</span>, <span style=color:#f60>2</span>, <span style=color:#f60>0</span>, -<span style=color:#f60>1</span>)
<span style=color:red>end</span>

<span style=color:red>return</span> M
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#0f0>&#34; in init.vim</span>
lua vim.api.nvim_command [[autocmd CursorHold   * lua require<span style=color:#87ceeb>&#39;utils&#39;</span>.blameVirtText()]]
lua vim.api.nvim_command [[autocmd CursorMoved  * lua require<span style=color:#87ceeb>&#39;utils&#39;</span>.clearBlameVirtText()]]
lua vim.api.nvim_command [[autocmd CursorMovedI * lua require<span style=color:#87ceeb>&#39;utils&#39;</span>.clearBlameVirtText()]]

hi! link GitLens Comment
</code></pre></div></section></article></main><h3>See Also</h3><ul><li><a href=/posts/2020-01-07-vimloop/>Using LibUV in Neovim</a></li><li><a href=/posts/2019-12-19-luanvim/>From init.vim to init.lua</a></li><li><a href=/posts/2019-08-25-vimcandothat/>Vim does that already</a></li></ul><footer><hr>‚ö°Ô∏è
2021 modified <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer></div></body></html>